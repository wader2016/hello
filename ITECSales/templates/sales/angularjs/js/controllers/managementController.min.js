/*! test 05-04-2016 */
MetronicApp.controller("AccountSettingController",["$scope","$http","authService","apiUrl","$timeout","$location","$rootScope","localStorageService",function(a,b,c,d,e,f,g,h){a.loginName=c.authentication.userName,b.get("http://"+d+"/Api/api/v1/UserProfile").success(function(e){a.userInfo=e.Data,"null"==a.userInfo.ContactInfo&&(c.logOut(),f.url("/Login/login/html")),a.ContactInfoDetail=JSON.parse(a.userInfo.ContactInfo),a.realName=a.ContactInfoDetail.Name,a.Tel=a.ContactInfoDetail.Tel1,a.loginEmail=a.ContactInfoDetail.Email1,g.Nick=a.ContactInfoDetail.Nick,a.MainAddressInfo=JSON.parse(a.userInfo.MainAddressInfo),a.StoreInfo=JSON.parse(a.userInfo.StoreInfo),b.get("http://"+d+"/Api/api/v1/Store").success(function(b){if(a.mapAddress=b.Data,null!==a.StoreInfo)for(var c=0;c<a.mapAddress.length;c++)a.mapAddress[c].StoreId==a.StoreInfo.Id&&(a.mapAdd=a.mapAddress[c],mapFun(a.mapAdd));else a.mapAdd=a.mapAddress[0],mapFun(a.mapAdd)}),a.userId=a.ContactInfoDetail.Id,a.Identity=a.userInfo.Identity,a.AddressInfo=JSON.parse(a.userInfo.AddressInfo);for(var h=0;h<a.AddressInfo.length;h++){a.AddressInfo[h].defaultSet=!1,a.AddressInfo[h].Id==a.MainAddressInfo[0].Id&&(a.AddressInfo[h].defaultSet=!0);var i=JSON.parse(a.AddressInfo[h].StrExt2),j=a.AddressInfo[h].AddressLine2,k="",l="";-1!=j.lastIndexOf("区")?(k=j.substring(0,j.lastIndexOf("区")+1),l=j.substring(j.lastIndexOf("区")+1)):-1!=j.lastIndexOf("县")?(k=j.substring(0,j.lastIndexOf("县")+1),l=j.substring(j.lastIndexOf("县")+1)):-1!=j.lastIndexOf("旗")?(k=j.substring(0,j.lastIndexOf("旗")+1),l=j.substring(j.lastIndexOf("旗")+1)):-1!=j.lastIndexOf("市")&&(k=j.substring(0,j.lastIndexOf("市")+1),l=j.substring(j.lastIndexOf("市")+1)),a.AddressInfo[h].addDetail=k,a.AddressInfo[h].area=l,a.AddressInfo[h].TelAndPhone=i}if(null!==a.userInfo.PaymentInfo){a.PaymentInfo=a.userInfo.PaymentInfo.split("|"),a.payInfo=[];for(var m=0;m<a.PaymentInfo.length;m++){var n=a.PaymentInfo[m].split(":")[1];a.payInfo.push(n)}a.CardNumber=a.payInfo[0],a.CardName=a.payInfo[1],a.IdCard=a.payInfo[2],a.CardPhone=a.payInfo[3]}a.InvoiceInfo=JSON.parse(a.userInfo.InvoiceInfo),null!==a.InvoiceInfo?(a.invoiceId=a.InvoiceInfo.Id,a.invoiceName=a.InvoiceInfo.Name,a.invoiceNumber=a.InvoiceInfo.Code,a.invoiceAddressAndPhone=a.InvoiceInfo.AddressLine,a.bankLine=a.InvoiceInfo.BankLine):a.invoiceId=0,b.get("http://"+d+"/Api/api/v1/UserProfile/"+a.Identity+"/MarketInfo").success(function(b){if(a.marketInfo=b.Data,null!==a.marketInfo){a.marketId=a.marketInfo.Id,a.birthDay=a.marketInfo.Birthday.substring(0,a.marketInfo.Birthday.indexOf(" ")),a.bikeClub=a.marketInfo.ClubInfo,a.checkItem=a.marketInfo.PurchaseIntention;for(var c=0;c<a.purchase.length;c++)a.purchase[c].intention==a.checkItem&&(a.checkId=a.purchase[c].Id);a.checkSaleItem=a.marketInfo.SalesInfoChannel;for(var d=0;d<a.SalesInfoChannel.length;d++)a.SalesInfoChannel[d].channel==a.checkSaleItem&&(a.checkSalesId=a.SalesInfoChannel[d].Id)}else a.marketId=0})}).error(function(){c.logOut(),f.url("/Login/login/html")}),a.saveForm=function(){var c={Id:a.userId,Name:a.realName,Tel:a.Tel,Nick:a.Nick};b.put("http://"+d+"/Api/api/v1/UserProfile/"+a.Identity+"/ContactInfo",c).success(function(){g.Nick=a.Nick,alertInfo.Success("保存成功!")}).error(function(){alertInfo.Error("保存失败!")})},a.updatePwd=function(){a.newPassword==a.confirmPassword?b.post("http://192.168.1.10:8083/api/account/ChangePassword",{UserName:a.loginName,CurrentPassword:a.password,NewPassword:a.newPassword}).success(function(){alertInfo.Success("密码修改成功!"),c.logOut(),i()}).error(function(){alertInfo.Error("修改失败!")}):alertInfo.Error("两次密码不一致!")};var i=function(){var a=e(function(){e.cancel(a),f.path("/login")},2e3)};a.getImg=function(){var b=document.getElementsByTagName("img");g.headImg=b[4].src,h.set(a.loginName+"image",g.headImg),alertInfo.Success("保存成功!")},b.get("/data/ProJson.json").success(function(b){a.getProvince=b}),b.get("/data/CityJson.json").success(function(b){a.City=b}),b.get("/data/DistrictJson.json").success(function(b){a.Street=b}),a.getCity=[],a.getProData=function(b){if(a.getCity=[],a.selCity=[],a.selStreet=[],null!=b){a.selectProvince=b.ProName;for(var c=0;c<a.City.length;c++)a.selProvince.ProID==a.City[c].ProID&&a.getCity.push(a.City[c])}},a.getStreet=[],a.getCityData=function(b){if(a.getStreet=[],a.selStreet=0,null!=b){a.selectCity=b.CityName;for(var c=0;c<a.Street.length;c++)a.selCity.CityID==a.Street[c].CityID&&a.getStreet.push(a.Street[c])}},a.getStreetData=function(b){null!=b&&(a.selectStreet=b.DisName)},a.defaultCheck=!1,a.setDefault=function(){},a.isChecked=function(a){return!!a},a.saveInfo=function(){null==a.listId&&(a.listId=0);var c={Id:a.listId,ContactWay:{Consignee:a.acceptName,Tel:a.telNumber,Phone:a.phoneNum},Province:a.selectProvince,City:a.selectCity,Street:a.selectStreet,AddressLine1:"",ZipCode:a.codeNum,AddressLine2:a.selectProvince+a.selectCity+a.selectStreet+a.detailAddress,DefaultAddress:a.defaultCheck},e={Name:a.acceptName,addDetail:a.selectProvince+a.selectCity+a.selectStreet,AddressLine2:a.selectProvince+a.selectCity+a.selectStreet+a.detailAddress,ZipCode:a.codeNum,TelAndPhone:{Tel:a.telNumber,Phone:a.phoneNum},defaultSet:a.defaultCheck};if(c.DefaultAddress)for(var f=0;f<a.AddressInfo.length;f++)a.AddressInfo[f].defaultSet=!1;b.put("http://"+d+"/Api/api/v1/UserProfile/"+a.Identity+"/AddressInfo",c).success(function(){0==c.Id?a.AddressInfo.push(e):a.AddressInfo.splice(a.listIndex,1,e),alertInfo.Success("保存成功！"),a.defaultCheck=!1,j()}).error(function(){alertInfo.Error("保存失败!")})};var j=function(){a.selProvince="",a.selCity="",a.selStreet="",a.acceptName="",a.phoneNum="",a.telNumber="",a.codeNum="",a.detailAddress="",a.defaultCheck=!1};a.updateInfo=function(b){a.listId=a.AddressInfo[b].Id,a.listIndex=b,a.acceptName=a.AddressInfo[b].Name,a.phoneNum=a.AddressInfo[b].TelAndPhone.Phone,a.telNumber=a.AddressInfo[b].TelAndPhone.Tel,a.codeNum=a.AddressInfo[b].ZipCode,a.detailAddress=a.AddressInfo[b].area,a.defaultCheck=a.AddressInfo[b].defaultSet,a.selectProvince=a.AddressInfo[b].Province,a.selectCity=a.AddressInfo[b].City,a.selectStreet=a.AddressInfo[b].Street},a.viewModal=function(b){a.delIndex=b},a.deleteInfo=function(){b["delete"]("http://"+d+"/Api/api/v1/UserProfile/"+a.Identity+"/"+a.AddressInfo[a.delIndex].Id).success(function(){}),a.AddressInfo.splice(a.delIndex,1)},a.showDefault=function(b){if(0==a.AddressInfo[b].defaultSet){for(var c=0;c<a.AddressInfo.length;c++)a.AddressInfo[c].showSet=!1;a.AddressInfo[b].showSet=!0}},a.hideDefault=function(){for(var b=0;b<a.AddressInfo.length;b++)a.AddressInfo[b].showSet=!1},a.changeAddress=function(c){for(var e=0;e<a.AddressInfo.length;e++)a.AddressInfo[e].showSet=!1,a.AddressInfo[e].defaultSet=!1;b.put("http://"+d+"/Api/api/v1/UserProfile/"+a.Identity+"/Address/"+a.AddressInfo[c].Id).success(function(){a.AddressInfo[c].defaultSet=!0,alertInfo.Success("修改成功!")}).error(function(){alertInfo.Error("修改失败!")})},a.bankInfo=function(){var c={CardNo:a.CardNumber,Name:a.CardName,Identity:a.IdCard,Tel:a.CardPhone};b.put("http://"+d+"/Api/api/v1/UserProfile/"+a.Identity+"/PayInfo",c).success(function(){alertInfo.Success("保存成功!")}).error(function(){alertInfo.Error("保存失败!")})},a.invoiceInfo=function(){var c={Id:a.invoiceId,Name:a.invoiceName,AddressLine:a.invoiceAddressAndPhone,Code:a.invoiceNumber,BankLine:a.bankLine};b.put("http://"+d+"/Api/api/v1/UserProfile/"+a.Identity+"/InvoiceInfo",c).success(function(){alertInfo.Success("保存成功!")}).error(function(){alertInfo.Error("更新失败!")})},a.saveAddress=function(){b.put("http://"+d+"/Api/api/v1/UserProfile/"+a.Identity+"/Store/"+a.mapAdd.StoreId).success(function(){alertInfo.Success("保存成功!")}).error(function(){alertInfo.Error("保存失败!")})},a.getMap=function(b){a.mapAdd=b,mapFun(b)},a.purchase=[{intention:"自己使用",Id:0,"for":"self"},{intention:"送朋友",Id:1,"for":"friend"},{intention:"收藏",Id:2,"for":"collection"},{intention:"其他",Id:3,"for":"else"}],a.SalesInfoChannel=[{channel:"偶然发现",Id:0,"for":"find"},{channel:"朋友介绍",Id:1,"for":"command"},{channel:"店铺推荐",Id:2,"for":"prefer"},{channel:"其他",Id:3,"for":"something"}],a.checkPurchase=function(b,c){a.checkId=c,a.checkItem=b.intention},a.checkChannel=function(b,c){a.checkSalesId=c,a.checkSaleItem=b.channel},a.saveSaleInfo=function(){var c={Id:a.marketId,Birthday:a.birthDay,ClubInfo:a.bikeClub,PurchaseIntention:a.checkItem,SalesInfoChannel:a.checkSaleItem};b.put("http://"+d+"/Api/api/v1/UserProfile/"+a.Identity+"/MarketInfo",c).success(function(){alertInfo.Success("保存成功!")}).error(function(){alertInfo.Error("保存失败!")})}}]),MetronicApp.controller("CompanySettingController",["$scope","$http","authService","localStorageService","apiUrl","$location",function(a,b,c,d,e,f){a.loginName=c.authentication.userName,b.get("http://"+e+"/Api/api/v1/Enterprise/GeneralTitle").success(function(b){a.GeneralTitle=b.Data}),b.get("http://"+e+"/Api/api/v1/Enterprise/GeneralRole").success(function(b){a.GeneralRole=b.Data}),b.get("http://"+e+"/Api/api/v1/Enterprise/GeneralDepartment").success(function(b){a.GeneralDepartment=b.Data}),b.get("http://"+e+"/Api/api/v1/UserProfile").success(function(d){a.userInfo=d.Data,"null"==a.userInfo.ContactInfo&&(c.logOut(),f.url("/Login/login/html")),a.parentId=a.userInfo.ParentId,b.get("http://"+e+"/Api/api/v1/Enterprise/"+a.parentId).success(function(b){a.company=b.Data,a.defaultCompanyName=a.company.Name,a.companyAbbr=a.company.Abbr,a.contactList=a.company.Contacts;for(var c=0;c<a.contactList.length;c++){a.contactList[c].defaultSet=!1,a.contactList[c].Name==a.company.ContactName&&(a.contactList[c].defaultSet=!0);for(var d=0;d<a.GeneralDepartment.length;d++)a.contactList[c].Department==a.GeneralDepartment[d].Id&&(a.contactList[c].Department=a.GeneralDepartment[d].Description);for(var e=0;e<a.GeneralRole.length;e++)a.contactList[c].Role==a.GeneralRole[e].Id&&(a.contactList[c].Role=a.GeneralRole[e].Description)}}),a.ContactInfo=JSON.parse(a.userInfo.ContactInfo),a.defaultName=a.ContactInfo.Name,a.defaultTel=a.ContactInfo.Tel1,a.contactId=a.ContactInfo.Id,a.MainAddressInfo=JSON.parse(a.userInfo.MainAddressInfo),""!=a.MainAddressInfo&&(a.addressId=a.MainAddressInfo[0].Id,a.defaultAddress=a.MainAddressInfo[0].AddressLine2),a.Identity=a.userInfo.Identity}).error(function(){c.logOut(),f.url("/Login/login/html")}),a.companySave=function(){var c={Id:a.parentId,ContactId:a.contactId,AddressId:a.addressId,Name:a.defaultCompanyName,Abbr:a.companyAbbr};b.put("http://"+e+"/Api/api/v1/Enterprise/"+a.Identity+"/EnterpriseInfo",c).success(function(){alertInfo.Success("保存成功!")}).error(function(){alertInfo.Error("保存失败!")})};var g=function(b){for(var c=0;c<b.length;c++)b[c].defaultSet&&(a.defaultName=b[c].Name,a.defaultTel=b[c].Tel1)};b.get("/data/ProJson.json").success(function(b){a.getProvince=b}),b.get("/data/CityJson.json").success(function(b){a.City=b}),b.get("/data/DistrictJson.json").success(function(b){a.Street=b}),a.selProvince=[],a.getCity=[],a.getProData=function(b){if(a.getCity=[],a.selCity=[],a.selStreet=[],null!=b){a.selectProvince=b.ProName;for(var c=0;c<a.City.length;c++)a.selProvince.ProID==a.City[c].ProID&&a.getCity.push(a.City[c])}},a.getStreet=[],a.getCityData=function(b){if(a.getStreet=[],a.selStreet=0,null!=b){a.selectCity=b.CityName;for(var c=0;c<a.Street.length;c++)a.selCity.CityID==a.Street[c].CityID&&a.getStreet.push(a.Street[c])}},a.getStreetData=function(b){null!=b&&(a.selectStreet=b.DisName)},a.defaultCheck=!1,a.setDefault=function(){1==a.defaultCheck?a.defaultCheck=!1:a.defaultCheck=!0},a.saveInfo=function(){null==a.listId&&(a.listId=0);var c={Contact:{Id:a.listId,Name:a.acceptName,Email1:a.email,Department:a.department.Id,Title:a.title.Id,Role:a.role.Id,Tel1:a.telNumber,Tel2:a.phoneNum},UserIdentity:a.Identity,EnterpriseId:a.parentId,IsDefaultContact:a.defaultCheck},d={Department:a.department.Description,Title:a.title.Description,Role:a.role.Description,Name:a.acceptName,Email1:a.email,Tel1:a.telNumber,Tel2:a.phoneNum,defaultSet:a.defaultCheck};if(c.IsDefaultContact)for(var f=0;f<a.contactList.length;f++)a.contactList[f].defaultSet=!1;b.put("http://"+e+"/Api/api/v1/Enterprise/Contact",c).success(function(){0==c.Contact.Id?(a.contactList.push(d),g(a.contactList)):a.contactList.splice(a.list,1,d),alertInfo.Success("保存成功!"),h()}).error(function(){alertInfo.Error("保存失败!")})};var h=function(){a.acceptName="",a.phoneNum="",a.telNumber="",a.email="",a.department="",a.title="",a.role="",a.defaultCheck=!1};a.updateInfo=function(b){a.listId=a.contactList[b].Id,a.list=b,a.acceptName=a.contactList[b].Name,a.phoneNum=a.contactList[b].Tel2,a.telNumber=a.contactList[b].Tel1,a.email=a.contactList[b].Email1,a.defaultCheck=a.contactList[b].defaultSet},a.viewModal=function(b){a.delIndex=b},a.deleteInfo=function(){a.contactList.splice(a.delIndex,1),g(a.contactList)},a.showDefault=function(b){if(0==a.contactList[b].defaultSet){for(var c=0;c<a.contactList.length;c++)a.contactList[c].showSet=!1;a.contactList[b].showSet=!0}},a.hideDefault=function(){for(var b=0;b<a.contactList.length;b++)a.contactList[b].showSet=!1},a.changeAddress=function(c){for(var d=0;d<a.contactList.length;d++)a.contactList[d].showSet=!1,a.contactList[d].defaultSet=!1;b.put("http://"+e+"/Api/api/v1/Enterprise/"+a.parentId+"/DefaultContact/"+a.contactList[c].Id).success(function(){a.contactList[c].defaultSet=!0,g(a.contactList),alertInfo.Success("设置成功!")}).error(function(){alertInfo.Error("设置失败!")})}}]),MetronicApp.controller("ProductManagementController",["$scope","$http",function(a,b){b.get("../angularjs/data/Product.json").success(function(b){a.product=b}).error(function(){})}]),MetronicApp.controller("UserProfileController",["$scope","$http","authService","$rootScope","localStorageService","apiUrl","$location",function(a,b,c,d,e,f,g){a.loginName=c.authentication.userName,d.headImg=e.get(a.loginName+"image"),b.get("http://"+f+"/Api/api/v1/UserProfile").success(function(b){a.userInfo=b.Data,"null"==a.userInfo.ContactInfo&&(c.logOut(),g.url("/Login/login/html")),d.Nick=JSON.parse(a.userInfo.ContactInfo).Nick}).error(function(){c.logOut(),g.url("/Login/login/html")})}]);